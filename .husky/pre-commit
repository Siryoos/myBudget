#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

# Run linting
echo "🔍 Running ESLint..."
npm run lint:fix

# Run TypeScript type checking
echo "📝 Checking TypeScript types..."
npm run type-check

# Run security checks
echo "🔒 Running security checks..."
node scripts/security-check.js

# Check for console.log statements
echo "🚫 Checking for console.log statements..."
if grep -r "console\.\(log\|error\|warn\|debug\)" --include="*.ts" --include="*.tsx" --exclude-dir=node_modules --exclude-dir=.next --exclude-dir=scripts --exclude="*.test.*" --exclude="*.spec.*" .; then
  echo "❌ Found console.log statements. Please use the logger utility instead."
  exit 1
fi

# Check for hardcoded secrets
echo "🔐 Checking for hardcoded secrets..."
if grep -r -E "(password|secret|key|token)\s*[:=]\s*['\"][^'\"]{8,}['\"]" --include="*.ts" --include="*.tsx" --include="*.js" --exclude-dir=node_modules --exclude-dir=.next --exclude="*.test.*" --exclude="*.example" --exclude="*.template" .; then
  echo "❌ Found potential hardcoded secrets. Please use environment variables."
  exit 1
fi

# Run tests for changed files
echo "🧪 Running tests for changed files..."
npm run test:changed

echo "✅ Pre-commit checks passed!"
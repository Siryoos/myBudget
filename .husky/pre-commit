#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Run TypeScript type checking
echo "üìù Checking TypeScript types..."
npm run type-check || {
  echo "‚ùå TypeScript type checking failed"
  exit 1
}

# Run ESLint
echo "üîß Running ESLint..."
npm run lint || {
  echo "‚ùå ESLint found issues"
  exit 1
}

# Run Prettier check
echo "üíÖ Checking code formatting..."
npm run format:check || {
  echo "‚ùå Code formatting check failed"
  exit 1
}

# Run security audit
echo "üîí Running security audit..."
npm audit --audit-level=moderate || {
  echo "‚ö†Ô∏è Security audit found issues"
  echo "Please review and fix security vulnerabilities"
}

# Run unit tests
echo "üß™ Running unit tests..."
npm run test:unit || {
  echo "‚ùå Unit tests failed"
  exit 1
}

# Check for secrets in staged files
echo "üîê Checking for secrets in staged files..."
npx detect-secrets scan --baseline .secrets.baseline || {
  echo "‚ö†Ô∏è Potential secrets detected"
  echo "Please review and remove any sensitive information"
}

# Check for large files
echo "üì¶ Checking for large files..."
git diff --cached --name-only | xargs -I {} sh -c '
  if [ -f "{}" ]; then
    size=$(stat -c%s "{}" 2>/dev/null || stat -f%z "{}" 2>/dev/null || echo "0")
    if [ "$size" -gt 1048576 ]; then
      echo "‚ö†Ô∏è Large file detected: {} ($(($size / 1024 / 1024))MB)"
      echo "Consider using Git LFS for large files"
    fi
  fi
'

echo "‚úÖ Pre-commit checks passed!"

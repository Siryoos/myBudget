# MyBudget Docker Setup Guide

This guide will help you set up and run MyBudget using Docker containers with separate services for the database, backend, and frontend.

## üê≥ Architecture Overview

The Docker setup consists of the following services:

- **PostgreSQL Database**: Persistent data storage with automatic initialization
- **Redis**: Caching and session storage
- **Backend API**: Next.js API routes running in a separate container
- **Frontend**: Next.js application running in a separate container
- **Nginx**: Reverse proxy with rate limiting and SSL support
- **Backup Service**: Automated database backups

## üöÄ Quick Start

### Prerequisites

- Docker Engine with Docker Compose plugin installed
- At least 4GB of available RAM
- Ports 80, 3000, 3001, 5432, 6379 available

### Security Setup

Before starting the application, ensure proper security configuration:

1. **Environment File**: 
   ```bash
   # Copy the example file (never commit the actual docker.env)
   cp docker.env.example docker.env
   
   # Edit the file to customize settings (keep passwords secure)
   nano docker.env
   ```

2. **File Permissions**:
   ```bash
   # Restrict access to environment file
   chmod 600 docker.env
   
   # Ensure only owner can read/write
   chown $USER:$USER docker.env
   ```

3. **Source Control**:
   ```bash
   # Add docker.env to .gitignore (if not already there)
   echo "docker.env" >> .gitignore
   
   # Verify it's ignored
   git status
   ```

- Docker Engine with Docker Compose plugin installed
- At least 4GB of available RAM
- Ports 80, 3000, 3001, 5432, 6379 available

### 1. Automated Setup (Recommended)

```bash
# Run the automated setup script
./scripts/docker-setup.sh

# Or manually:
chmod +x scripts/docker-setup.sh
./scripts/docker-setup.sh
```

This script will:
- Check Docker installation
- Create necessary directories
- Generate environment file with secure passwords
- Build and start all services
- Wait for services to be healthy
- Show service status and URLs

### 2. Manual Setup

```bash
# Copy environment file
cp docker.env.example .env

# Edit .env with your preferences
nano .env

# Create directories
mkdir -p database/backups logs uploads nginx/logs nginx/ssl

# Build and start services
docker compose up -d

# Check service status
docker compose ps
```

## üîß Environment Configuration

### Environment Variables

**‚ö†Ô∏è Security Note**: Never commit passwords or secrets to source control. The `docker.env` file is automatically generated with secure, random passwords and should be kept private.

The `docker.env.example` file contains all necessary configuration:

```bash
# Database
DB_NAME=mybudget
DB_USER=mybudget_user
DB_PASSWORD=<auto-generated>
DB_HOST=postgres
DB_PORT=5432

# Redis
REDIS_HOST=redis
REDIS_PORT=6379
REDIS_PASSWORD=<auto-generated>

# JWT
JWT_SECRET=<auto-generated>
JWT_EXPIRES_IN=7d

# Application
NODE_ENV=production
PORT=3001
CORS_ORIGIN=http://localhost:3000,https://localhost:3000

# Frontend
NEXT_PUBLIC_API_URL=http://localhost:3001
NEXT_PUBLIC_APP_URL=http://localhost:3000
```

### Password Generation

The setup script automatically generates:
- **Database Password**: 25-character complex password
- **Redis Password**: 25-character complex password
- **JWT Secret**: 50-character complex secret

### Security Best Practices

1. **Environment File**: 
   - The `docker.env` file contains sensitive information and should never be committed to source control
   - It's automatically generated by the setup script with secure passwords
   - Keep this file secure and restrict access to authorized personnel only

2. **Password Requirements**:
   - Database passwords are minimum 25 characters with mixed case, numbers, and special characters
   - JWT secrets are minimum 50 characters for enhanced security
   - All passwords are randomly generated and unique per installation

3. **Docker Compose Security**:
   - All services now use environment variables instead of hardcoded passwords
   - The `env_file` directive loads sensitive data from `docker.env`
   - No credentials are stored in the docker-compose.yml file
- **Session Secret**: 32-character complex secret

## üèóÔ∏è Service Details

### PostgreSQL Database

- **Image**: `postgres:15-alpine`
- **Port**: 5432
- **Data**: Persistent volume `postgres_data`
- **Initialization**: Automatic schema creation and sample data
- **Health Check**: `pg_isready` command

### Redis

- **Image**: `redis:7-alpine`
- **Port**: 6379
- **Data**: Persistent volume `redis_data`
- **Authentication**: Password-protected
- **Health Check**: Redis ping command

### Backend API

- **Base Image**: `node:18-alpine`
- **Port**: 3001
- **Build**: Multi-stage build for production
- **Health Check**: `/health` endpoint
- **Volumes**: Source code, logs, uploads

### Frontend

- **Base Image**: `node:18-alpine`
- **Port**: 3000
- **Build**: Multi-stage build for production
- **Health Check**: Frontend health endpoint
- **Volumes**: Source code, public assets, locales

### Nginx

- **Image**: `nginx:alpine`
- **Ports**: 80 (HTTP), 443 (HTTPS)
- **Features**: Rate limiting, gzip compression, proxy
- **SSL**: Configurable for production

## üìÅ Directory Structure

```
mybudget/
‚îú‚îÄ‚îÄ docker-compose.yml          # Main Docker Compose file
‚îú‚îÄ‚îÄ docker-compose.dev.yml      # Development overrides
‚îú‚îÄ‚îÄ Dockerfile.backend          # Backend container
‚îú‚îÄ‚îÄ Dockerfile.frontend         # Frontend container
‚îú‚îÄ‚îÄ .env                        # Environment variables
‚îú‚îÄ‚îÄ docker.env.example          # Environment template
‚îú‚îÄ‚îÄ database/
‚îÇ   ‚îú‚îÄ‚îÄ init/                   # Database initialization scripts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ 01-init.sql        # Schema and sample data
‚îÇ   ‚îî‚îÄ‚îÄ backups/                # Database backups
‚îú‚îÄ‚îÄ nginx/
‚îÇ   ‚îú‚îÄ‚îÄ nginx.conf              # Nginx configuration
‚îÇ   ‚îú‚îÄ‚îÄ logs/                   # Nginx logs
‚îÇ   ‚îî‚îÄ‚îÄ ssl/                    # SSL certificates
‚îú‚îÄ‚îÄ logs/                       # Application logs
‚îú‚îÄ‚îÄ uploads/                    # File uploads
‚îî‚îÄ‚îÄ scripts/
    ‚îú‚îÄ‚îÄ docker-setup.sh         # Setup script
    ‚îî‚îÄ‚îÄ backup.sh               # Backup script
```

## üöÄ Usage Commands

### Basic Operations

```bash
# Start all services
docker compose up -d

# Stop all services
docker compose down

# Restart all services
docker compose restart

# View logs
docker compose logs -f

# View logs for specific service
docker compose logs -f backend

# Check service status
docker compose ps

# Access service shell
docker compose exec backend sh
docker compose exec postgres psql -U mybudget_user -d mybudget
```

### Development Mode

```bash
# Start with development overrides
docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# Development features:
# - Hot reloading
# - Source code mounted as volumes
# - Development dependencies
# - Exposed ports for debugging
```

### Management Script

```bash
# Complete setup
./scripts/docker-setup.sh

# Start services
./scripts/docker-setup.sh start

# Stop services
./scripts/docker-setup.sh stop

# Restart services
./scripts/docker-setup.sh restart

# View logs
./scripts/docker-setup.sh logs [service]

# Show status
./scripts/docker-setup.sh status

# Clean up everything
./scripts/docker-setup.sh cleanup
```

## üîç Monitoring and Debugging

### Health Checks

All services include health checks:

```bash
# Check backend health
curl http://localhost:3001/health

# Check nginx health
curl http://localhost/health

# Check database health
docker compose exec postgres pg_isready -U mybudget_user -d mybudget
```

### Logs

```bash
# View all logs
docker compose logs -f

# View specific service logs
docker compose logs -f backend
docker compose logs -f frontend
docker compose logs -f postgres

# View nginx logs
docker compose logs -f nginx
```

### Database Access

```bash
# Connect to database
docker compose exec postgres psql -U mybudget_user -d mybudget

# Run SQL commands
docker compose exec postgres psql -U mybudget_user -d mybudget -c "SELECT * FROM users;"

# Backup database
docker compose exec postgres pg_dump -U mybudget_user -d mybudget > backup.sql
```

## üîí Security Features

### Network Isolation

- All services run in isolated `mybudget-network`
- Services communicate via internal network
- Only necessary ports exposed to host

### Authentication

- Database: Strong password authentication
- Redis: Password-protected
- JWT: Complex secret keys
- API: Rate limiting and validation

### Data Protection

- Persistent volumes for data
- Regular automated backups
- Encrypted passwords
- Input validation

## üìä Performance Optimization

### Resource Limits

```yaml
# Add to docker-compose.yml for production
services:
  backend:
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '0.5'
        reservations:
          memory: 512M
          cpus: '0.25'
```

### Scaling

```bash
# Scale backend service
docker-compose up -d --scale backend=3

# Scale with load balancer
docker-compose up -d --scale backend=3 --scale frontend=2
```

## üöÄ Production Deployment

### Environment Variables

```bash
# Production overrides
NODE_ENV=production
SSL_ENABLED=true
RATE_LIMIT_MAX_REQUESTS=100
LOG_LEVEL=warn
```

### SSL Configuration

1. Place SSL certificates in `nginx/ssl/`
2. Uncomment HTTPS server in `nginx/nginx.conf`
3. Set `SSL_ENABLED=true` in environment

### Backup Strategy

```bash
# Automated backups (cron job)
0 2 * * * docker compose run --rm backup

# Manual backup
docker compose run --rm backup

# Restore from backup
docker compose exec postgres psql -U mybudget_user -d mybudget < backup.sql
```

## üß™ Testing

### API Testing

```bash
# Test health endpoint
curl http://localhost:3001/health

# Test frontend
curl http://localhost:3000

# Test with authentication
curl -H "Authorization: Bearer YOUR_JWT_TOKEN" http://localhost:3001/api/budgets
```

### Load Testing

```bash
# Install Apache Bench
sudo apt-get install apache2-utils

# Test API performance
ab -n 1000 -c 10 http://localhost:3001/health

# Test frontend performance
ab -n 1000 -c 10 http://localhost:3000
```

## üÜò Troubleshooting

### Common Issues

1. **Port Conflicts**
   ```bash
   # Check what's using the port
   sudo netstat -tulpn | grep :3000
   
   # Change ports in docker-compose.yml
   ports:
     - "3001:3001"  # Change to "3002:3001"
   ```

2. **Permission Issues**
   ```bash
   # Fix directory permissions
   sudo chown -R $USER:$USER logs uploads database/backups
   ```

3. **Database Connection Issues**
   ```bash
   # Check database logs
docker compose logs postgres

# Test connection
docker compose exec postgres pg_isready -U mybudget_user -d mybudget
   ```

4. **Memory Issues**
   ```bash
   # Check container resource usage
   docker stats
   
   # Increase Docker memory limit in Docker Desktop
   ```

### Debug Mode

```bash
# Start with debug logging
docker compose up -d
docker compose logs -f

# Access container for debugging
docker compose exec backend sh
docker compose exec frontend sh
```

## üìö Additional Resources

### Documentation

- [Docker Compose Reference](https://docs.docker.com/compose/)
- [PostgreSQL Docker Image](https://hub.docker.com/_/postgres)
- [Redis Docker Image](https://hub.docker.com/_/redis)
- [Nginx Docker Image](https://hub.docker.com/_/nginx)

### Community

- [Docker Community](https://community.docker.com/)
- [Stack Overflow](https://stackoverflow.com/questions/tagged/docker)
- [GitHub Issues](https://github.com/docker/compose/issues)

---

**Happy containerizing! üê≥**
